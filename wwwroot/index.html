<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="0;url=/auth.html">
    <title>Redirecting to Login...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        
        .redirect-container {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 3rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 500px;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .links {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .close:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        /* Form Styles */
        form {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Module Management Styles */
        .modules-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .module-checkbox {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border: 1px solid #eee;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .module-checkbox:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }
        
        .module-checkbox input[type="checkbox"] {
            margin-right: 0.75rem;
            margin-top: 0.2rem;
        }
        
        .module-info {
            flex: 1;
            cursor: pointer;
        }
        
        .module-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .module-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* Admin Panel Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .swagger-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .swagger-link:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .module-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .module-content {
            display: none;
        }
        
        .module-content.active {
            display: block;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .module-title {
            font-size: 1.8rem;
            margin: 0;
            color: #333;
        }
        
        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
        }
        
        /* Message Styles */
        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            color: #666;
            font-style: italic;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="redirect-container">
        <div class="spinner"></div>
        <h2>🚀 Redirecting to Authentication...</h2>
        <p>You are being redirected to the login page. If the redirect doesn't work automatically, please click the button below.</p>
        
        <div class="links">
            <a href="/auth.html" class="link">🔑 Go to Login</a>
            <a href="/swagger/index.html" class="link">📚 API Documentation</a>
        </div>
        
        <p style="font-size: 0.9rem; margin-top: 2rem; opacity: 0.7;">
            For security reasons, the admin panel requires authentication.
        </p>
    </div>
    
    <script>
        // Fallback redirect in case meta refresh doesn't work
        setTimeout(function() {
            window.location.href = '/auth.html';
        }, 2000);
    </script>
    <div class="header">
        <h1>🚀 Yopo Backend Admin Panel</h1>
        <a href="/swagger/index.html" class="swagger-link">📚 API Documentation</a>
    </div>
    
    <div class="container">
        <div class="module-tabs">
            <button class="tab active" onclick="showModule('invitations')">📧 Invitations</button>
            <button class="tab" onclick="showModule('usertypes')">👥 User Types</button>
            <button class="tab" onclick="showModule('buildings')">🏢 Buildings</button>
        </div>
        
        <!-- Invitations Module -->
        <div id="invitations" class="module-content active">
            <div class="module-header">
                <h2 class="module-title">Invitation Management</h2>
                <button class="btn btn-primary" onclick="showAddInvitationModal()">+ Add Invitation</button>
            </div>
            
            <div class="stats" id="invitation-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-invitations">-</div>
                    <div class="stat-label">Total Invitations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-invitations">-</div>
                    <div class="stat-label">Active Invitations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expired-invitations">-</div>
                    <div class="stat-label">Expired Invitations</div>
                </div>
            </div>
            
            <div id="invitation-messages"></div>
            
            <div class="table-container">
                <table class="table" id="invitations-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>User Role</th>
                            <th>Status</th>
                            <th>Expires</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invitations-tbody">
                        <tr>
                            <td colspan="7" class="loading">Loading invitations...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- User Types Module -->
        <div id="usertypes" class="module-content">
            <div class="module-header">
                <h2 class="module-title">User Type Management</h2>
                <button class="btn btn-primary" onclick="showAddUserTypeModal()">+ Add User Type</button>
            </div>
            
            <div class="stats" id="usertype-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-usertypes">-</div>
                    <div class="stat-label">Total User Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-usertypes">-</div>
                    <div class="stat-label">Active User Types</div>
                </div>
            </div>
            
            <div id="usertype-messages"></div>
            
            <div class="table-container">
                <table class="table" id="usertypes-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Modules</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usertypes-tbody">
                        <tr>
                            <td colspan="7" class="loading">Loading user types...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Buildings Module -->
        <div id="buildings" class="module-content">
            <div class="module-header">
                <h2 class="module-title">Building Management</h2>
                <button class="btn btn-primary" onclick="showAddBuildingModal()">+ Add Building</button>
            </div>
            
            <div class="stats" id="building-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-buildings">-</div>
                    <div class="stat-label">Total Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-buildings">-</div>
                    <div class="stat-label">Active Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inactive-buildings">-</div>
                    <div class="stat-label">Inactive Buildings</div>
                </div>
            </div>
            
            <div id="building-messages"></div>
            
            <div class="buildings-controls">
                <div class="view-toggle">
                    <button class="active" onclick="toggleView('cards')">📱 Card View</button>
                    <button onclick="toggleView('table')">📊 Table View</button>
                </div>
            </div>
            
            <!-- Card View -->
            <div id="buildings-card-view" class="buildings-grid">
                <div class="loading">Loading buildings...</div>
            </div>
            
            <!-- Table View -->
            <div id="buildings-table-view" class="table-container" style="display: none;">
                <table class="table" id="buildings-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Photo</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="buildings-tbody">
                        <tr>
                            <td colspan="7" class="loading">Loading buildings...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Invitation Modal -->
    <div id="invitation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="invitation-modal-title">Add Invitation</h3>
                <button class="close" onclick="closeModal('invitation-modal')">&times;</button>
            </div>
            <form id="invitation-form">
                <div class="form-group">
                    <label for="invitation-email">Email Address</label>
                    <input type="email" id="invitation-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="invitation-role">User Role</label>
                    <select id="invitation-role" class="form-control" required>
                        <option value="">Loading user types...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="invitation-days">Expiry Days (1-7)</label>
                    <input type="number" id="invitation-days" class="form-control" min="1" max="7" value="7" required>
                </div>
                <div class="form-row">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('invitation-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="invitation-submit-btn">Add Invitation</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit User Type Modal -->
    <div id="usertype-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="usertype-modal-title">Add User Type</h3>
                <button class="close" onclick="closeModal('usertype-modal')">&times;</button>
            </div>
            <form id="usertype-form">
                <div class="form-group">
                    <label for="usertype-name">Name</label>
                    <input type="text" id="usertype-name" class="form-control" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="usertype-description">Description</label>
                    <textarea id="usertype-description" class="form-control" rows="3" maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label>Module Access</label>
                    <div id="usertype-modules-container" class="modules-container">
                        <div class="loading">Loading modules...</div>
                    </div>
                </div>
                <div class="form-row">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('usertype-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="usertype-submit-btn">Add User Type</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Building Modal -->
    <div id="building-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="building-modal-title">Add Building</h3>
                <button class="close" onclick="closeModal('building-modal')">&times;</button>
            </div>
            <form id="building-form">
                <div class="form-group">
                    <label for="building-name">Building Name</label>
                    <input type="text" id="building-name" class="form-control" required maxlength="200">
                </div>
                <div class="form-group">
                    <label for="building-address">Address</label>
                    <textarea id="building-address" class="form-control" rows="3" required maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label for="building-photo">Photo URL</label>
                    <input type="url" id="building-photo" class="form-control" maxlength="1000" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-row">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('building-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="building-submit-btn">Add Building</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // API Base URL
        const API_BASE = '/api';
        
        // Global variables
        let currentEditingInvitation = null;
        let currentEditingUserType = null;
        let currentEditingBuilding = null;
        let availableModules = [];
        let availableUserTypes = [];
        let currentBuildingView = 'cards';
        
        // Global authentication state
        let currentUser = null;
        let authToken = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication first (now async)
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                showLoginRequired();
                return;
            }
            
            // Load user info
            loadCurrentUser();
            
            loadAvailableModules();
            loadAvailableUserTypes();
            loadInvitations();
            loadUserTypes();
            loadBuildings();
            
            // Set up form handlers
            document.getElementById('invitation-form').addEventListener('submit', handleInvitationSubmit);
            document.getElementById('usertype-form').addEventListener('submit', handleUserTypeSubmit);
            document.getElementById('building-form').addEventListener('submit', handleBuildingSubmit);
        });
        
        // Module switching
        function showModule(moduleId) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.module-content').forEach(content => content.classList.remove('active'));
            document.getElementById(moduleId).classList.add('active');
            
            // Reload data
            if (moduleId === 'invitations') {
                loadInvitations();
            } else if (moduleId === 'usertypes') {
                loadUserTypes();
            } else if (moduleId === 'buildings') {
                loadBuildings();
            }
        }
        
        // Utility functions
        function showMessage(containerId, message, type = 'error') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString() + ' ' + new Date(dateString).toLocaleTimeString();
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Reset form
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
            
            // Reset global editing variables
            currentEditingInvitation = null;
            currentEditingUserType = null;
            currentEditingBuilding = null;
        }
        
        // INVITATION FUNCTIONS
        async function loadInvitations() {
            try {
                const response = await fetch(`${API_BASE}/invitations`);
                if (!response.ok) throw new Error('Failed to fetch invitations');
                
                const invitations = await response.json();
                displayInvitations(invitations);
                updateInvitationStats(invitations);
            } catch (error) {
                showMessage('invitation-messages', `Error loading invitations: ${error.message}`);
                document.getElementById('invitations-tbody').innerHTML = 
                    '<tr><td colspan="7" class="error">Failed to load invitations</td></tr>';
            }
        }
        
        function displayInvitations(invitations) {
            const tbody = document.getElementById('invitations-tbody');
            
            if (invitations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No invitations found</td></tr>';
                return;
            }
            
            tbody.innerHTML = invitations.map(invitation => `
                <tr>
                    <td>${invitation.id}</td>
                    <td>${invitation.emailAddress}</td>
                    <td>${invitation.userTypeName}</td>
                    <td><span class="badge ${invitation.isExpired ? 'badge-danger' : 'badge-success'}">
                        ${invitation.isExpired ? 'Expired' : 'Active'}
                    </span></td>
                    <td>${formatDate(invitation.expiryTime)}</td>
                    <td>${formatDate(invitation.createdAt)}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; margin-right: 0.5rem; font-size: 0.875rem;" 
                                onclick="editInvitation(${invitation.id})">Edit</button>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                onclick="deleteInvitation(${invitation.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateInvitationStats(invitations) {
            const total = invitations.length;
            const active = invitations.filter(i => !i.isExpired).length;
            const expired = invitations.filter(i => i.isExpired).length;
            
            document.getElementById('total-invitations').textContent = total;
            document.getElementById('active-invitations').textContent = active;
            document.getElementById('expired-invitations').textContent = expired;
        }
        
        function showAddInvitationModal() {
            currentEditingInvitation = null;
            document.getElementById('invitation-modal-title').textContent = 'Add Invitation';
            document.getElementById('invitation-submit-btn').textContent = 'Add Invitation';
            openModal('invitation-modal');
        }
        
        async function editInvitation(id) {
            try {
                const response = await fetch(`${API_BASE}/invitations/${id}`);
                if (!response.ok) throw new Error('Failed to fetch invitation');
                
                const invitation = await response.json();
                currentEditingInvitation = invitation;
                
                document.getElementById('invitation-modal-title').textContent = 'Edit Invitation';
                document.getElementById('invitation-submit-btn').textContent = 'Update Invitation';
                document.getElementById('invitation-email').value = invitation.emailAddress;
                document.getElementById('invitation-role').value = invitation.userTypeId;
                document.getElementById('invitation-days').value = invitation.daysUntilExpiry || 7;
                
                openModal('invitation-modal');
            } catch (error) {
                showMessage('invitation-messages', `Error loading invitation: ${error.message}`);
            }
        }
        
        async function deleteInvitation(id) {
            if (!confirm('Are you sure you want to delete this invitation?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/invitations/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete invitation');
                
                showMessage('invitation-messages', 'Invitation deleted successfully!', 'success');
                loadInvitations();
            } catch (error) {
                showMessage('invitation-messages', `Error deleting invitation: ${error.message}`);
            }
        }
        
        async function handleInvitationSubmit(e) {
            e.preventDefault();
            
            const email = document.getElementById('invitation-email').value;
            const role = document.getElementById('invitation-role').value;
            const days = parseInt(document.getElementById('invitation-days').value);
            
            const data = {
                emailAddress: email,
                userTypeId: parseInt(role),
                expiryDays: days
            };
            
            try {
                let response;
                if (currentEditingInvitation) {
                    // Update
                    response = await fetch(`${API_BASE}/invitations/${currentEditingInvitation.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create
                    response = await fetch(`${API_BASE}/invitations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData);
                }
                
                const action = currentEditingInvitation ? 'updated' : 'created';
                showMessage('invitation-messages', `Invitation ${action} successfully!`, 'success');
                closeModal('invitation-modal');
                loadInvitations();
            } catch (error) {
                showMessage('invitation-messages', `Error: ${error.message}`);
            }
        }
        
        // USER TYPE FUNCTIONS
        async function loadUserTypes() {
            try {
                const response = await fetch(`${API_BASE}/usertypes`);
                if (!response.ok) throw new Error('Failed to fetch user types');
                
                const userTypes = await response.json();
                displayUserTypes(userTypes);
                updateUserTypeStats(userTypes);
            } catch (error) {
                showMessage('usertype-messages', `Error loading user types: ${error.message}`);
                document.getElementById('usertypes-tbody').innerHTML = 
                    '<tr><td colspan="7" class="error">Failed to load user types</td></tr>';
            }
        }
        
        function displayUserTypes(userTypes) {
            const tbody = document.getElementById('usertypes-tbody');
            
            if (userTypes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No user types found</td></tr>';
                return;
            }
            
            tbody.innerHTML = userTypes.map(userType => `
                <tr>
                    <td>${userType.id}</td>
                    <td>${userType.name}</td>
                    <td>${userType.description || '-'}</td>
                    <td><span class="badge ${userType.isActive ? 'badge-success' : 'badge-danger'}">
                        ${userType.isActive ? 'Active' : 'Inactive'}
                    </span></td>
                    <td>${userType.moduleNames ? userType.moduleNames.join(', ') : '-'}</td>
                    <td>${formatDate(userType.createdAt)}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; margin-right: 0.5rem; font-size: 0.875rem;" 
                                onclick="editUserType(${userType.id})">Edit</button>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                onclick="deleteUserType(${userType.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateUserTypeStats(userTypes) {
            const total = userTypes.length;
            const active = userTypes.filter(ut => ut.isActive).length;
            
            document.getElementById('total-usertypes').textContent = total;
            document.getElementById('active-usertypes').textContent = active;
        }
        
        function showAddUserTypeModal() {
            currentEditingUserType = null;
            document.getElementById('usertype-modal-title').textContent = 'Add User Type';
            document.getElementById('usertype-submit-btn').textContent = 'Add User Type';
            openModal('usertype-modal');
        }
        
        async function editUserType(id) {
            try {
                const response = await fetch(`${API_BASE}/usertypes/${id}`);
                if (!response.ok) throw new Error('Failed to fetch user type');
                
                const userType = await response.json();
                currentEditingUserType = userType;
                
                document.getElementById('usertype-modal-title').textContent = 'Edit User Type';
                document.getElementById('usertype-submit-btn').textContent = 'Update User Type';
                document.getElementById('usertype-name').value = userType.name;
                document.getElementById('usertype-description').value = userType.description || '';
                
                // Set selected modules using checkboxes
                setSelectedModules(userType.moduleIds || []);
                
                openModal('usertype-modal');
            } catch (error) {
                showMessage('usertype-messages', `Error loading user type: ${error.message}`);
            }
        }
        
        async function deleteUserType(id) {
            if (!confirm('Are you sure you want to delete this user type?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/usertypes/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete user type');
                
                showMessage('usertype-messages', 'User type deleted successfully!', 'success');
                loadUserTypes();
            } catch (error) {
                showMessage('usertype-messages', `Error deleting user type: ${error.message}`);
            }
        }
        
        async function handleUserTypeSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('usertype-name').value;
            const description = document.getElementById('usertype-description').value;
            
            // Get selected module IDs from checkboxes
            const moduleIds = getSelectedModuleIds();
            
            const data = {
                name: name,
                description: description,
                moduleIds: moduleIds
            };
            
            if (currentEditingUserType) {
                data.isActive = currentEditingUserType.isActive;
            }
            
            try {
                let response;
                if (currentEditingUserType) {
                    // Update
                    response = await fetch(`${API_BASE}/usertypes/${currentEditingUserType.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create
                    response = await fetch(`${API_BASE}/usertypes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData);
                }
                
                const action = currentEditingUserType ? 'updated' : 'created';
                showMessage('usertype-messages', `User type ${action} successfully!`, 'success');
                closeModal('usertype-modal');
                loadUserTypes();
            } catch (error) {
                showMessage('usertype-messages', `Error: ${error.message}`);
            }
        }
        
        // MODULE FUNCTIONS
        async function loadAvailableModules() {
            try {
                const response = await fetch(`${API_BASE}/modules`);
                if (!response.ok) throw new Error('Failed to fetch modules');
                
                const moduleData = await response.json();
                availableModules = moduleData.modules || [];
                renderModuleCheckboxes();
            } catch (error) {
                console.error('Error loading modules:', error);
                document.getElementById('usertype-modules-container').innerHTML = 
                    '<div class="error">Failed to load modules</div>';
            }
        }
        
        function renderModuleCheckboxes() {
            const container = document.getElementById('usertype-modules-container');
            
            if (availableModules.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No modules available</div>';
                return;
            }
            
            container.innerHTML = availableModules.map(module => `
                <div class="module-checkbox">
                    <input type="checkbox" id="module-${module.id}" value="${module.id}">
                    <label for="module-${module.id}" class="module-info">
                        <div class="module-name">${module.name} (ID: ${module.id})</div>
                        ${module.description ? `<div class="module-description">${module.description}</div>` : ''}
                    </label>
                </div>
            `).join('');
        }
        
        function setSelectedModules(moduleIds) {
            // Clear all checkboxes first
            availableModules.forEach(module => {
                const checkbox = document.getElementById(`module-${module.id}`);
                if (checkbox) checkbox.checked = false;
            });
            
            // Set selected modules
            if (moduleIds && moduleIds.length > 0) {
                moduleIds.forEach(id => {
                    const checkbox = document.getElementById(`module-${id}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }
        
        function getSelectedModuleIds() {
            const selectedIds = [];
            availableModules.forEach(module => {
                const checkbox = document.getElementById(`module-${module.id}`);
                if (checkbox && checkbox.checked) {
                    selectedIds.push(module.id);
                }
            });
            return selectedIds;
        }
        
        // USER TYPE DROPDOWN FUNCTIONS
        async function loadAvailableUserTypes() {
            try {
                const response = await fetch(`${API_BASE}/invitations/user-types`);
                if (!response.ok) throw new Error('Failed to fetch user types for invitation dropdown');
                
                const userTypes = await response.json();
                availableUserTypes = userTypes || [];
                renderUserTypeDropdown();
            } catch (error) {
                console.error('Error loading user types for dropdown:', error);
                const dropdown = document.getElementById('invitation-role');
                dropdown.innerHTML = '<option value="">Error loading user types</option>';
            }
        }
        
        function renderUserTypeDropdown() {
            const dropdown = document.getElementById('invitation-role');
            
            if (availableUserTypes.length === 0) {
                dropdown.innerHTML = '<option value="">No user types available</option>';
                return;
            }
            
            dropdown.innerHTML = `
                <option value="">Select a user type...</option>
                ${availableUserTypes.map(userType => 
                    `<option value="${userType.id}">${userType.name}${userType.description ? ' - ' + userType.description : ''}</option>`
                ).join('')}
            `;
        }
        
        // BUILDING FUNCTIONS
        async function loadBuildings() {
            try {
                const response = await fetch(`${API_BASE}/buildings`);
                if (!response.ok) throw new Error('Failed to fetch buildings');
                
                const buildings = await response.json();
                displayBuildings(buildings);
                updateBuildingStats(buildings);
            } catch (error) {
                showMessage('building-messages', `Error loading buildings: ${error.message}`);
                document.getElementById('buildings-card-view').innerHTML = 
                    '<div class="error">Failed to load buildings</div>';
                document.getElementById('buildings-tbody').innerHTML = 
                    '<tr><td colspan="7" class="error">Failed to load buildings</td></tr>';
            }
        }
        
        function displayBuildings(buildings) {
            if (currentBuildingView === 'cards') {
                displayBuildingCards(buildings);
            } else {
                displayBuildingTable(buildings);
            }
        }
        
        function displayBuildingCards(buildings) {
            const container = document.getElementById('buildings-card-view');
            
            if (buildings.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No buildings found</div>';
                return;
            }
            
            container.innerHTML = buildings.map(building => `
                <div class="building-card">
                    <div class="building-image">
                        ${building.photo ? 
                            `<img src="${building.photo}" alt="${building.name}" onerror="this.parentElement.innerHTML='<div class=\'no-image\'>🏢</div>';">` : 
                            '<div class="no-image">🏢</div>'
                        }
                        <div class="building-status">
                            <span class="badge ${building.isActive ? 'badge-success' : 'badge-danger'}">
                                ${building.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="building-content">
                        <h3 class="building-title">${building.name}</h3>
                        <div class="building-address">${building.address}</div>
                        <div class="building-meta">
                            <div class="building-date">
                                Created: ${formatDate(building.createdAt)}
                                ${building.updatedAt ? `<br>Updated: ${formatDate(building.updatedAt)}` : ''}
                            </div>
                            <div class="building-actions">
                                <button class="btn btn-secondary btn-small" onclick="editBuilding(${building.id})">
                                    ✏️ Edit
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteBuilding(${building.id})">
                                    🗑️ Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayBuildingTable(buildings) {
            const tbody = document.getElementById('buildings-tbody');
            
            if (buildings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No buildings found</td></tr>';
                return;
            }
            
            tbody.innerHTML = buildings.map(building => `
                <tr>
                    <td>${building.id}</td>
                    <td>${building.name}</td>
                    <td>${building.address}</td>
                    <td>${building.photo ? 
                        `<a href="${building.photo}" target="_blank">📷 View</a>` : 
                        '<span style="color: #999;">No photo</span>'
                    }</td>
                    <td><span class="badge ${building.isActive ? 'badge-success' : 'badge-danger'}">
                        ${building.isActive ? 'Active' : 'Inactive'}
                    </span></td>
                    <td>${formatDate(building.createdAt)}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; margin-right: 0.5rem; font-size: 0.875rem;" 
                                onclick="editBuilding(${building.id})">Edit</button>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                onclick="deleteBuilding(${building.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateBuildingStats(buildings) {
            const total = buildings.length;
            const active = buildings.filter(b => b.isActive).length;
            const inactive = buildings.filter(b => !b.isActive).length;
            
            document.getElementById('total-buildings').textContent = total;
            document.getElementById('active-buildings').textContent = active;
            document.getElementById('inactive-buildings').textContent = inactive;
        }
        
        function toggleView(viewType) {
            currentBuildingView = viewType;
            
            // Update button states
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Toggle views
            if (viewType === 'cards') {
                document.getElementById('buildings-card-view').style.display = 'grid';
                document.getElementById('buildings-table-view').style.display = 'none';
            } else {
                document.getElementById('buildings-card-view').style.display = 'none';
                document.getElementById('buildings-table-view').style.display = 'block';
            }
            
            // Reload buildings to display in correct format
            loadBuildings();
        }
        
        function showAddBuildingModal() {
            currentEditingBuilding = null;
            document.getElementById('building-modal-title').textContent = 'Add Building';
            document.getElementById('building-submit-btn').textContent = 'Add Building';
            openModal('building-modal');
        }
        
        async function editBuilding(id) {
            try {
                const response = await fetch(`${API_BASE}/buildings/${id}`);
                if (!response.ok) throw new Error('Failed to fetch building');
                
                const building = await response.json();
                currentEditingBuilding = building;
                
                document.getElementById('building-modal-title').textContent = 'Edit Building';
                document.getElementById('building-submit-btn').textContent = 'Update Building';
                document.getElementById('building-name').value = building.name;
                document.getElementById('building-address').value = building.address;
                document.getElementById('building-photo').value = building.photo || '';
                
                openModal('building-modal');
            } catch (error) {
                showMessage('building-messages', `Error loading building: ${error.message}`);
            }
        }
        
        async function deleteBuilding(id) {
            if (!confirm('Are you sure you want to delete this building?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/buildings/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete building');
                
                showMessage('building-messages', 'Building deleted successfully!', 'success');
                loadBuildings();
            } catch (error) {
                showMessage('building-messages', `Error deleting building: ${error.message}`);
            }
        }
        
        async function handleBuildingSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('building-name').value.trim();
            const address = document.getElementById('building-address').value.trim();
            const photo = document.getElementById('building-photo').value.trim();
            
            if (!name || !address) {
                showMessage('building-messages', 'Please fill in all required fields.');
                return;
            }
            
            const data = {
                name: name,
                address: address,
                photo: photo || null
            };
            
            if (currentEditingBuilding) {
                data.isActive = currentEditingBuilding.isActive;
            }
            
            try {
                let response;
                if (currentEditingBuilding) {
                    // Update
                    response = await fetch(`${API_BASE}/buildings/${currentEditingBuilding.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create
                    response = await fetch(`${API_BASE}/buildings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData);
                }
                
                const action = currentEditingBuilding ? 'updated' : 'created';
                showMessage('building-messages', `Building ${action} successfully!`, 'success');
                closeModal('building-modal');
                loadBuildings();
            } catch (error) {
                showMessage('building-messages', `Error: ${error.message}`);
            }
        }
        
        // AUTHENTICATION FUNCTIONS
        
        async function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const expiry = localStorage.getItem('tokenExpiry');
            
            if (!token || !expiry) {
                return false;
            }
            
            // Check if token is expired
            if (new Date() >= new Date(expiry)) {
                // Token expired, clear storage
                localStorage.removeItem('authToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('userData');
                return false;
            }
            
            // IMPORTANT: Verify token with server to ensure it's valid
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Token is invalid, clear storage
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('tokenExpiry');
                    localStorage.removeItem('userData');
                    return false;
                }
                
                authToken = token;
                return true;
            } catch (error) {
                console.error('Authentication verification failed:', error);
                // On network error, clear storage to be safe
                localStorage.removeItem('authToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('userData');
                return false;
            }
        }
        
        function showLoginRequired() {
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    text-align: center;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">
                    <div style="
                        background: rgba(255,255,255,0.1);
                        padding: 3rem;
                        border-radius: 16px;
                        backdrop-filter: blur(10px);
                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                        max-width: 500px;
                    ">
                        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">🔒</h1>
                        <h2 style="font-size: 1.8rem; margin-bottom: 1rem; font-weight: 600;">Admin Access Required</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 2rem; opacity: 0.9; line-height: 1.6;">
                            You need to be logged in to access the admin panel. Please sign in with your administrator account.
                        </p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <a href="/auth.html" style="
                                background: rgba(255,255,255,0.2);
                                color: white;
                                padding: 0.875rem 1.5rem;
                                border-radius: 8px;
                                text-decoration: none;
                                font-weight: 600;
                                transition: all 0.3s ease;
                                display: inline-block;
                                border: 1px solid rgba(255,255,255,0.3);
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)';">
                                🔑 Sign In
                            </a>
                            <a href="/swagger/index.html" style="
                                background: transparent;
                                color: white;
                                padding: 0.875rem 1.5rem;
                                border-radius: 8px;
                                text-decoration: none;
                                font-weight: 600;
                                transition: all 0.3s ease;
                                display: inline-block;
                                border: 1px solid rgba(255,255,255,0.3);
                            " onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='transparent'; this.style.transform='translateY(0)';">
                                📚 API Docs
                            </a>
                        </div>
                        <p style="font-size: 0.9rem; margin-top: 2rem; opacity: 0.7;">
                            Don't have an account? Contact your system administrator.
                        </p>
                    </div>
                </div>
            `;
        }
        
        async function loadCurrentUser() {
            try {
                const userData = localStorage.getItem('userData');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    updateHeaderWithUser();
                } else {
                    // Fallback: fetch from API
                    await fetchCurrentUserFromAPI();
                }
            } catch (error) {
                console.error('Error loading current user:', error);
            }
        }
        
        async function fetchCurrentUserFromAPI() {
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token is invalid, redirect to login
                        localStorage.clear();
                        showLoginRequired();
                        return;
                    }
                    throw new Error('Failed to fetch user data');
                }
                
                const user = await response.json();
                currentUser = user;
                localStorage.setItem('userData', JSON.stringify(user));
                updateHeaderWithUser();
            } catch (error) {
                console.error('Error fetching current user:', error);
            }
        }
        
        function updateHeaderWithUser() {
            if (!currentUser) return;
            
            const header = document.querySelector('.header');
            const existingUserInfo = header.querySelector('.user-info');
            
            if (existingUserInfo) {
                existingUserInfo.remove();
            }
            
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            userInfo.style.cssText = `
                display: flex;
                align-items: center;
                gap: 1rem;
                color: white;
            `;
            
            const userName = currentUser.fullName || `${currentUser.firstName} ${currentUser.lastName}`;
            const userRole = currentUser.userTypeName || 'Admin';
            const userInitial = currentUser.firstName ? currentUser.firstName.charAt(0).toUpperCase() : 'U';
            
            userInfo.innerHTML = `
                <div style="
                    width: 35px;
                    height: 35px;
                    border-radius: 50%;
                    background: rgba(255,255,255,0.2);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 600;
                    font-size: 1rem;
                ">${userInitial}</div>
                <div>
                    <div style="font-weight: 600; font-size: 0.95rem;">${userName}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">${userRole}</div>
                </div>
                <button onclick="logout()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.2s ease;
                    font-size: 0.9rem;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
                    Logout
                </button>
            `;
            
            const swaggerLink = header.querySelector('.swagger-link');
            header.insertBefore(userInfo, swaggerLink);
        }
        
        async function logout() {
            try {
                // Call logout API
                if (authToken) {
                    await fetch(`${API_BASE}/users/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }).catch(() => {
                        // Ignore errors during logout API call
                    });
                }
            } catch (error) {
                console.error('Error during logout:', error);
            } finally {
                // Always clear local storage and redirect
                localStorage.removeItem('authToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('userData');
                
                // Redirect to login page
                window.location.href = '/auth.html';
            }
        }
        
        // Add authorization header to API requests
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            // Only add auth header for our API calls
            if (url.startsWith(API_BASE) || url.startsWith('/api')) {
                options.headers = options.headers || {};
                if (authToken && !options.headers['Authorization']) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }
            }
            return originalFetch(url, options);
        };
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
